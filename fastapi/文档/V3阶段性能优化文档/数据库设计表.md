
### 3.4 Êï∞ÊçÆÂ∫ìËÆæËÆ°

#### 3.4.1 Áî®Êà∑Á≥ªÁªüË°®Ôºàv1Ôºâ

```sql
CREATE TABLE us_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50) DEFAULT NULL UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.4.2 ÊñáÊ°£Á≥ªÁªüË°®Ôºàv2Ôºâ

```sql
-- Êñá‰ª∂Â§πË°®
CREATE TABLE us_folders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    level TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES us_folders(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE
);

-- ÊñáÊ°£Ë°®
CREATE TABLE us_documents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content LONGTEXT,
    file_path VARCHAR(500),
    file_type ENUM('md', 'pdf') NOT NULL DEFAULT 'md',
    file_size INT DEFAULT 0,
    summary TEXT,
    status ENUM('draft', 'published', 'review_failed') DEFAULT 'draft',
    publish_time TIMESTAMP NULL,
    review_message TEXT,
    folder_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (folder_id) REFERENCES us_folders(id) ON DELETE SET NULL,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE
);

-- Êñá‰ª∂‰∏ä‰º†Ë°®
CREATE TABLE us_upload_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INT NOT NULL,
    file_type ENUM('md', 'pdf') NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    status ENUM('uploading', 'uploaded', 'validated', 'failed', 'deleted') DEFAULT 'uploading',
    validation_message TEXT,
    user_id INT NOT NULL,
    document_id INT DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE SET NULL
);

-- ÁºñËæëÂô®‰ºöËØùË°®
CREATE TABLE us_editor_sessions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    title VARCHAR(200) DEFAULT NULL,
    content LONGTEXT,
    is_draft BOOLEAN DEFAULT TRUE,
    session_type ENUM('new_document', 'edit_document') DEFAULT 'new_document',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_document_id (document_id),
    INDEX idx_session_type (session_type)
);

-- AI‰ºòÂåñËÆ∞ÂΩïË°®
CREATE TABLE us_ai_optimizations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    session_id INT NOT NULL,
    user_id INT NOT NULL,
    original_content LONGTEXT NOT NULL,
    optimized_content LONGTEXT NOT NULL,
    optimization_prompt TEXT,
    ai_provider VARCHAR(50) DEFAULT 'default',
    status ENUM('pending', 'completed', 'failed') DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES us_editor_sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- AIÂÆ°Ê†∏Êó•ÂøóË°®
CREATE TABLE us_ai_review_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    review_type ENUM('content_safety') NOT NULL,
    ai_provider VARCHAR(50) DEFAULT 'default',
    file_id VARCHAR(100) DEFAULT NULL,
    review_prompt TEXT NOT NULL,
    ai_response LONGTEXT,
    review_result ENUM('pending', 'passed', 'failed', 'error') DEFAULT 'pending',
    failure_reason TEXT,
    confidence_score DECIMAL(3,2) DEFAULT NULL,
    review_duration INT DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_review_result (review_result),
    INDEX idx_created_at (created_at)
);

```sql
-- ÂèëÂ∏ÉËÆ∞ÂΩïË°®ÔºàÁª≠Ôºâ
CREATE TABLE us_publish_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    publish_version INT DEFAULT 1,
    publish_status ENUM('draft', 'pending_review', 'review_passed', 'review_failed', 'published', 'unpublished') DEFAULT 'draft',
    publish_time TIMESTAMP NULL,
    unpublish_time TIMESTAMP NULL,
    publish_reason TEXT,
    unpublish_reason TEXT,
    review_id INT DEFAULT NULL,
    view_count INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    publish_config JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_publish_status (publish_status),
    INDEX idx_publish_time (publish_time)
);

-- ÂèëÂ∏ÉÂéÜÂè≤Ë°®
CREATE TABLE us_publish_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    publish_record_id INT NOT NULL,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    action_type ENUM('submit', 'approve', 'reject', 'publish', 'unpublish', 'edit') NOT NULL,
    action_reason TEXT,
    old_status VARCHAR(50),
    new_status VARCHAR(50),
    operator_id INT,
    action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (publish_record_id) REFERENCES us_publish_records(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (operator_id) REFERENCES us_users(id) ON DELETE SET NULL,
    INDEX idx_publish_record_id (publish_record_id),
    INDEX idx_document_id (document_id),
    INDEX idx_action_time (action_time)
);
```

#### 3.4.3 ‰∫íÂä®ÂäüËÉΩË°®Ôºàv2Ôºâ

```sql
-- ÁÇπËµûË°®
CREATE TABLE us_document_likes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_document_like (user_id, document_id),
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- Êî∂ËóèË°®
CREATE TABLE us_document_favorites (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_document_favorite (user_id, document_id),
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- ËØÑËÆ∫Ë°®ÔºàÊîØÊåÅ‰∫åÂ±ÇÁªìÊûÑÔºâ
CREATE TABLE us_document_comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    parent_id INT DEFAULT NULL,
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES us_document_comments(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at)
);

-- ‰∫íÂä®ÁªüËÆ°Ë°®ÔºàÁî®‰∫éÁºìÂ≠òÁªüËÆ°Êï∞ÊçÆÔºâ
CREATE TABLE us_document_interaction_stats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL UNIQUE,
    like_count INT DEFAULT 0,
    favorite_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id)
);
```

#### 3.4.4 ÂàÜ‰∫´Á≥ªÁªüË°®Ôºàv2 Êñ∞Â¢ûÔºâ üÜï

```sql
-- ÂàÜ‰∫´Ë°®
CREATE TABLE us_document_shares (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    share_code VARCHAR(32) NOT NULL UNIQUE,
    share_type ENUM('public', 'private', 'password') DEFAULT 'public' NOT NULL,
    share_password VARCHAR(100) DEFAULT NULL,
    allow_download BOOLEAN DEFAULT TRUE,
    allow_comment BOOLEAN DEFAULT TRUE,
    status ENUM('active', 'expired', 'disabled') DEFAULT 'active' NOT NULL,
    expire_time DATETIME DEFAULT NULL,
    view_count INT DEFAULT 0,
    download_count INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_share_code (share_code),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- ÂàÜ‰∫´ËÆøÈóÆÊó•ÂøóË°®
CREATE TABLE us_share_access_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    share_id INT NOT NULL,
    visitor_ip VARCHAR(45) DEFAULT NULL,
    visitor_user_agent TEXT DEFAULT NULL,
    visitor_user_id INT DEFAULT NULL,
    access_type ENUM('VIEW', 'DOWNLOAD', 'COMMENT') NOT NULL,
    access_result VARCHAR(50) DEFAULT 'success',
    accessed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (share_id) REFERENCES us_document_shares(id) ON DELETE CASCADE,
    FOREIGN KEY (visitor_user_id) REFERENCES us_users(id) ON DELETE SET NULL,
    INDEX idx_share_id (share_id),
    INDEX idx_visitor_user_id (visitor_user_id),
    INDEX idx_access_type (access_type),
    INDEX idx_accessed_at (accessed_at)
);
```

#### 3.4.5 ÊÄßËÉΩ‰ºòÂåñÁ¥¢Âºï

```sql
-- ÊäÄÊúØÂπøÂú∫Ê®°ÂùóÊÄßËÉΩ‰ºòÂåñÁ¥¢Âºï
CREATE INDEX idx_documents_status_publish_time ON us_documents(status, publish_time DESC);
CREATE INDEX idx_publish_records_status_time ON us_publish_records(publish_status, publish_time DESC);
CREATE INDEX idx_documents_title_content ON us_documents(title, content(100));
CREATE INDEX idx_publish_records_view_count ON us_publish_records(view_count DESC);

-- ‰∫íÂä®ÂäüËÉΩÊ®°ÂùóÊÄßËÉΩ‰ºòÂåñÁ¥¢Âºï
CREATE INDEX idx_user_document_like ON us_document_likes(user_id, document_id);
CREATE INDEX idx_user_document_favorite ON us_document_favorites(user_id, document_id);
CREATE INDEX idx_document_comments_parent ON us_document_comments(document_id, parent_id);
CREATE INDEX idx_interaction_stats_document ON us_document_interaction_stats(document_id);

-- ÂàÜ‰∫´Á≥ªÁªüÊ®°ÂùóÊÄßËÉΩ‰ºòÂåñÁ¥¢Âºï üÜï
CREATE INDEX idx_user_document_share ON us_document_shares(user_id, document_id);
CREATE INDEX idx_share_access_time ON us_share_access_logs(share_id, accessed_at);
CREATE INDEX idx_share_type_status ON us_document_shares(share_type, status);
```
