你说得对！我应该在原有的完整文档基础上进行更新。让我重新整理完整的技术文档。

# 📘 FastAPI 模块化文档管理系统 - 完整技术文档 (v5.0)

> **最后更新**：2025年10月16日  
> **项目状态**：✅ `interaction` 模块开发完成并通过测试  
> **架构原则**：模块化 + 版本化 + 零侵入 + 自动注册 + API响应格式预测试

---

## 📋 目录

- [1. 接口文档](#1-接口文档)
- [2. 开发文档](#2-开发文档)
- [3. 开发经验总结](#3-开发经验总结)
- [4. 继续开发指南](#4-继续开发指南)
- [5. 快速启动命令](#5-快速启动命令)

---

## 1. 接口文档

### 1.1 基础信息

- **基础地址**：`http://localhost:8100`
- **认证方式**：`Authorization: Bearer <access_token>`
- **Content-Type**：`application/json`
- **测试账号**：
  - 用户名：`abc`
  - 密码：`ljl18420`
- **数据库**：`user_system`

---

### 1.2 v1 用户系统接口（✅ 已完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/register` | POST | 用户注册 | ❌ |
| `/check-username/{username}` | GET | 检查用户名可用性 | ❌ |
| `/check-email/{email}` | GET | 检查邮箱可用性 | ❌ |
| `/login` | POST | 用户登录 | ❌ |
| `/me` | GET | 获取当前用户信息 | ✅ |
| `/refresh` | POST | 刷新token | ✅ |
| `/nickname` | PUT | 更新昵称 | ✅ |
| `/check-nickname/{nickname}` | GET | 检查昵称可用性 | ✅ |
| `/logout` | POST | 退出登录 | ✅ |
| `/change-password` | POST | 修改密码 | ✅ |
| `/check-strength` | POST | 检查密码强度 | ❌ |
| `/user-info` | GET | 获取用户信息 | ✅ |

---

### 1.3 v2 文档管理接口（✅ 已完成）

#### 文件夹管理
| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/folders` | POST | 创建文件夹 | ✅ |
| `/folders/tree` | GET | 获取文件夹树 | ✅ |
| `/folders/{folder_id}` | DELETE | 删除文件夹 | ✅ |

#### 文档管理
| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/documents` | POST | 创建文档 | ✅ |
| `/documents` | GET | 获取文档列表（分页） | ✅ |
| `/documents/{doc_id}` | GET | 获取文档详情 | ✅ |
| `/documents/{doc_id}` | PUT | 更新文档 | ✅ |
| `/documents/{doc_id}` | DELETE | 删除文档 | ✅ |
| `/stats` | GET | 获取统计信息 | ✅ |

---

### 1.4 v2 文件上传接口（✅ 已完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/config` | GET | 获取上传配置 | ✅ |
| `/validate` | POST | 验证文件（不保存） | ✅ |
| `/upload` | POST | 上传文件 | ✅ |
| `/uploads` | GET | 获取上传历史（分页） | ✅ |
| `/uploads/{upload_id}` | GET | 获取上传详情 | ✅ |
| `/create-document` | POST | 从上传文件创建文档 | ✅ |
| `/uploads/{upload_id}` | DELETE | 删除上传记录 | ✅ |
| `/stats` | GET | 获取上传统计 | ✅ |

---

### 1.5 v2 MD编辑器接口（✅ 已完成）

#### 会话管理
| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/config` | GET | 获取编辑器配置 | ✅ |
| `/sessions` | POST | 创建编辑器会话 | ✅ |
| `/sessions` | GET | 获取会话列表（分页） | ✅ |
| `/sessions/{session_id}` | GET | 获取会话详情 | ✅ |
| `/sessions/{session_id}` | PUT | 更新会话内容 | ✅ |
| `/sessions/{session_id}` | DELETE | 删除会话 | ✅ |

#### AI优化功能
| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/sessions/{session_id}/optimize` | POST | AI优化内容 | ✅ |
| `/sessions/{session_id}/apply-optimization/{optimization_id}` | POST | 应用优化结果 | ✅ |
| `/sessions/{session_id}/optimizations` | GET | 获取优化历史 | ✅ |

#### 文档保存
| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/sessions/{session_id}/save-document` | POST | 保存为正式文档 | ✅ |
| `/stats` | GET | 获取编辑器统计 | ✅ |

---

### 1.6 v2 AI审核接口（✅ 已完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/submit-review` | POST | 提交文档审核 | ✅ |
| `/review-status/{document_id}` | GET | 查询审核状态 | ✅ |
| `/review-history` | GET | 获取审核历史 | ✅ |
| `/review-detail/{review_id}` | GET | 获取审核详情 | ✅ |
| `/retry-review/{document_id}` | POST | 重新审核文档 | ✅ |
| `/stats` | GET | 获取审核统计 | ✅ |
| `/config` | GET | 获取审核配置 | ✅ |
| `/review-log/{review_id}` | DELETE | 删除审核记录 | ✅ |
| `/recent-reviews` | GET | 获取最近审核 | ✅ |

---

### 1.7 v2 文档发布接口（✅ 已完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/submit` | POST | 提交文档发布 | ✅ |
| `/published` | GET | 获取已发布文档列表（分页） | ❌ |
| `/document/{doc_id}` | GET | 获取文档发布详情 | ✅ |
| `/unpublish/{doc_id}` | POST | 撤回已发布文档 | ✅ |
| `/my-records` | GET | 获取我的发布记录 | ✅ |
| `/stats` | GET | 获取发布统计 | ✅ |
| `/view/{doc_id}` | POST | 增加文档浏览量 | ❌ |
| `/status/{doc_id}` | GET | 获取文档发布状态 | ✅ |
| `/config` | GET | 获取发布配置 | ❌ |

---

### 1.8 v2 技术广场接口（✅ 已完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/documents` | GET | 获取文档列表（分页+筛选+排序） | ❌ |
| `/documents/{document_id}` | GET | 获取文档详情 | ❌ |
| `/search` | GET | 搜索文档 | ❌ |
| `/category-stats` | GET | 获取分类统计 | ❌ |
| `/hot-documents` | GET | 获取热门文档 | ❌ |
| `/latest-documents` | GET | 获取最新文档 | ❌ |
| `/stats` | GET | 获取技术广场统计 | ❌ |
| `/view/{document_id}` | POST | 增加文档浏览量 | ❌ |

#### 📌 关键接口示例

**获取文档列表（支持多维度筛选）**
```bash
curl "http://localhost:8100/api/v2/tech_square/documents?page=1&size=20&file_type=md&sort_by=popular&time_filter=week"
```

**搜索文档**
```bash
curl "http://localhost:8100/api/v2/tech_square/search?keyword=技术&file_type=md&page=1&size=10"
```

**获取热门文档**
```bash
curl "http://localhost:8100/api/v2/tech_square/hot-documents?limit=10"
```

---

### 1.9 v2 互动功能接口（✅ 新增完成）

| 接口路径 | 方法 | 功能 | 认证 |
|----------|------|------|------|
| `/test` | GET | 测试接口 | ❌ |
| `/documents/{document_id}/like` | POST | 切换点赞状态 | ✅ |
| `/documents/{document_id}/like-status` | GET | 获取点赞状态 | ❌ |
| `/documents/{document_id}/favorite` | POST | 切换收藏状态 | ✅ |
| `/documents/{document_id}/favorite-status` | GET | 获取收藏状态 | ❌ |
| `/my-favorites` | GET | 获取我的收藏列表 | ✅ |
| `/documents/{document_id}/comments` | POST | 创建评论或回复 | ✅ |
| `/documents/{document_id}/comments` | GET | 获取评论列表 | ❌ |
| `/comments/{comment_id}` | PUT | 更新评论 | ✅ |
| `/comments/{comment_id}` | DELETE | 删除评论 | ✅ |
| `/documents/{document_id}/stats` | GET | 获取文档互动统计 | ❌ |
| `/my-stats` | GET | 获取我的互动统计 | ✅ |

#### 📌 关键接口示例

**点赞文档**
```bash
curl -X POST "http://localhost:8100/api/v2/interaction/documents/45/like" \
-H "Authorization: Bearer YOUR_TOKEN"
```

**获取收藏列表**
```bash
curl "http://localhost:8100/api/v2/interaction/my-favorites?page=1&size=20" \
-H "Authorization: Bearer YOUR_TOKEN"
```

**创建评论**
```bash
curl -X POST "http://localhost:8100/api/v2/interaction/documents/45/comments" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{"content":"这是一个测试评论"}'
```

---

### 1.10 错误码说明

| 状态码 | 说明 | 示例 |
|--------|------|------|
| 200 | 成功 | 操作成功完成 |
| 400 | 请求错误 | 参数验证失败、业务逻辑错误、重复提交 |
| 401 | 认证失败 | Token无效或过期 |
| 404 | 资源不存在 | 文档、会话或文件夹不存在、无权限访问 |
| 422 | 数据格式错误 | JSON格式错误、字段类型错误 |
| 500 | 服务器错误 | 内部服务器错误、AI服务异常、数据库错误 |

---

## 2. 开发文档

### 2.1 项目目录结构

```bash
fastapi/
├── app/
│   ├── core/                     # 核心基础设施
│   │   ├── __init__.py
│   │   ├── config.py             # JWT/DB/Token 配置
│   │   ├── database.py           # SQLAlchemy 引擎 + SessionLocal
│   │   └── ai_client.py          # AI客户端（集成自定义AI服务）
│   │
│   ├── modules/                  # 业务模块根目录
│   │   ├── v1/                   # API 版本 v1（用户系统）
│   │   │   ├── __init__.py
│   │   │   ├── user_register/    # ✅ 用户注册模块
│   │   │   ├── user_auth/        # ✅ 用户认证模块
│   │   │   ├── user_profile/     # ✅ 用户中心模块
│   │   │   └── password_manager/ # ✅ 密码管理模块
│   │   │
│   │   └── v2/                   # API 版本 v2（文档系统）
│   │       ├── __init__.py
│   │       ├── document_manager/ # ✅ 文档管理模块
│   │       ├── file_upload/      # ✅ 文件上传模块
│   │       ├── md_editor/        # ✅ MD编辑器模块
│   │       ├── ai_review/        # ✅ AI审核模块
│   │       ├── document_publish/ # ✅ 文档发布模块
│   │       ├── tech_square/      # ✅ 技术广场模块
│   │       └── interaction/      # ✅ 互动功能模块（新增）
│   │           ├── models.py     # 互动数据模型
│   │           ├── schemas.py    # API验证模型
│   │           ├── services.py   # 业务逻辑服务
│   │           ├── routes.py     # API路由（12个接口）
│   │           └── dependencies.py # 依赖注入
│   │
│   └── main.py                   # 🚀 应用入口：自动扫描并注册模块
│
├── uploads/                      # 文件上传目录
│   └── user_{user_id}/           # 用户隔离的上传目录
│       └── documents/            # 文档文件存储
│
├── .env                          # 环境变量
├── requirements.txt              # 依赖列表
├── README.md                     # 项目说明
└── 测试脚本/
    ├── api_response_test.py      # ✅ API响应格式测试脚本（新增）
    └── v2测试脚本/
        ├── test_document_manager_clean.py
        ├── test_file_upload_clean.py
        ├── test_md_editor_clean.py
        ├── test_ai_review_clean.py
        ├── test_document_publish_clean.py
        ├── test_tech_square_clean.py
        └── test_interaction_clean.py    # ✅ 新增测试脚本
```

---

### 2.2 环境配置信息

#### 2.2.1 数据库配置

**数据库连接信息**：
```bash
# .env 文件配置
DATABASE_URL=mysql+pymysql://root:ljl18420@localhost:3306/user_system
SECRET_KEY=your-secret-key-here-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

**数据库连接命令**：
```bash
# Windows CMD连接MySQL
mysql -u root -p
# 输入密码：ljl18420

# 使用项目数据库
USE user_system;

# 查看所有表
SHOW TABLES;
```

#### 2.2.2 测试账号信息

**标准测试账号**：
- **用户名**：`abc`
- **密码**：`ljl18420`
- **邮箱**：`ljlaa@qq.com`

**登录接口调用示例**：
```bash
curl -X POST "http://localhost:8100/api/v1/user_auth/login" \
-H "Content-Type: application/json" \
-d '{"username_or_email":"abc","password":"ljl18420"}'
```

---

### 2.3 技术架构

#### 2.3.1 架构设计原则

- **模块化设计**：每个功能独立成模块，互不干扰
- **版本化管理**：v1用户系统，v2文档系统，支持并行开发
- **自动注册**：新模块无需修改`main.py`，自动发现和注册
- **零侵入原则**：新增功能不影响现有功能
- **统一依赖管理**：所有模块共享`core`中的基础设施
- **AI服务集成**：统一AI客户端，支持多种AI服务配置

#### 2.3.2 互动功能架构 🆕

- **数据模型设计**：
  ```python
  # 四个核心表
  us_document_likes         # 点赞记录（防重复）
  us_document_favorites     # 收藏记录（防重复）
  us_document_comments      # 评论记录（二层结构）
  us_document_interaction_stats  # 统计缓存
  ```

- **业务逻辑架构**：
  ```python
  # 点赞系统：切换式点赞，实时统计更新
  # 收藏系统：个人收藏夹管理
  # 评论系统：支持评论+回复的二层结构，软删除
  # 统计系统：文档统计+用户行为统计
  ```

- **性能优化**：
  ```python
  # 数据库索引优化
  CREATE INDEX idx_user_document_like ON us_document_likes(user_id, document_id);
  CREATE INDEX idx_document_comments_parent ON us_document_comments(document_id, parent_id);
  
  # 统计缓存机制
  us_document_interaction_stats 表缓存热点统计数据
  ```

---

### 2.4 数据库设计

#### 2.4.1 用户系统表（v1）

```sql
CREATE TABLE us_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50) DEFAULT NULL UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 2.4.2 文档系统表（v2）

```sql
-- 文件夹表
CREATE TABLE us_folders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    level TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES us_folders(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE
);

-- 文档表
CREATE TABLE us_documents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content LONGTEXT,
    file_path VARCHAR(500),
    file_type ENUM('md', 'pdf') NOT NULL DEFAULT 'md',
    file_size INT DEFAULT 0,
    summary TEXT,
    status ENUM('draft', 'published', 'review_failed') DEFAULT 'draft',
    publish_time TIMESTAMP NULL,
    review_message TEXT,
    folder_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (folder_id) REFERENCES us_folders(id) ON DELETE SET NULL,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE
);

-- 文件上传表
CREATE TABLE us_upload_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INT NOT NULL,
    file_type ENUM('md', 'pdf') NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    status ENUM('uploading', 'uploaded', 'validated', 'failed', 'deleted') DEFAULT 'uploading',
    validation_message TEXT,
    user_id INT NOT NULL,
    document_id INT DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE SET NULL
);

-- 编辑器会话表
CREATE TABLE us_editor_sessions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT DEFAULT NULL,
    user_id INT NOT NULL,
    title VARCHAR(200) DEFAULT NULL,
    content LONGTEXT,
    is_draft BOOLEAN DEFAULT TRUE,
    session_type ENUM('new_document', 'edit_document') DEFAULT 'new_document',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_document_id (document_id),
    INDEX idx_session_type (session_type)
);

-- AI优化记录表
CREATE TABLE us_ai_optimizations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    session_id INT NOT NULL,
    user_id INT NOT NULL,
    original_content LONGTEXT NOT NULL,
    optimized_content LONGTEXT NOT NULL,
    optimization_prompt TEXT,
    ai_provider VARCHAR(50) DEFAULT 'default',
    status ENUM('pending', 'completed', 'failed') DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES us_editor_sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- AI审核日志表
CREATE TABLE us_ai_review_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    review_type ENUM('content_safety') NOT NULL,
    ai_provider VARCHAR(50) DEFAULT 'default',
    file_id VARCHAR(100) DEFAULT NULL,
    review_prompt TEXT NOT NULL,
    ai_response LONGTEXT,
    review_result ENUM('pending', 'passed', 'failed', 'error') DEFAULT 'pending',
    failure_reason TEXT,
    confidence_score DECIMAL(3,2) DEFAULT NULL,
    review_duration INT DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_review_result (review_result),
    INDEX idx_created_at (created_at)
);

-- 发布记录表
CREATE TABLE us_publish_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    publish_version INT DEFAULT 1,
    publish_status ENUM('draft', 'pending_review', 'review_passed', 'review_failed', 'published', 'unpublished') DEFAULT 'draft',
    publish_time TIMESTAMP NULL,
    unpublish_time TIMESTAMP NULL,
    publish_reason TEXT,
    unpublish_reason TEXT,
    review_id INT DEFAULT NULL,
    view_count INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    publish_config JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_publish_status (publish_status),
    INDEX idx_publish_time (publish_time)
);

-- 发布历史表
CREATE TABLE us_publish_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    publish_record_id INT NOT NULL,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    action_type ENUM('submit', 'approve', 'reject', 'publish', 'unpublish', 'edit') NOT NULL,
    action_reason TEXT,
    old_status VARCHAR(50),
    new_status VARCHAR(50),
    operator_id INT,
    action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (publish_record_id) REFERENCES us_publish_records(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (operator_id) REFERENCES us_users(id) ON DELETE SET NULL,
    INDEX idx_publish_record_id (publish_record_id),
    INDEX idx_document_id (document_id),
    INDEX idx_action_time (action_time)
);
```

#### 2.4.3 互动功能表（v2 新增） 🆕

```sql
-- 点赞表
CREATE TABLE us_document_likes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_document_like (user_id, document_id),
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- 收藏表
CREATE TABLE us_document_favorites (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_document_favorite (user_id, document_id),
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- 评论表（支持二层结构）
CREATE TABLE us_document_comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL,
    user_id INT NOT NULL,
    parent_id INT DEFAULT NULL,
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES us_users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES us_document_comments(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id),
    INDEX idx_user_id (user_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at)
);

-- 互动统计表（用于缓存统计数据）
CREATE TABLE us_document_interaction_stats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    document_id INT NOT NULL UNIQUE,
    like_count INT DEFAULT 0,
    favorite_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES us_documents(id) ON DELETE CASCADE,
    INDEX idx_document_id (document_id)
);
```

#### 2.4.4 性能优化索引 🆕

```sql
-- 技术广场模块性能优化索引
CREATE INDEX idx_documents_status_publish_time ON us_documents(status, publish_time DESC);
CREATE INDEX idx_publish_records_status_time ON us_publish_records(publish_status, publish_time DESC);
CREATE INDEX idx_documents_title_content ON us_documents(title, content(100));
CREATE INDEX idx_publish_records_view_count ON us_publish_records(view_count DESC);

-- 互动功能模块性能优化索引
CREATE INDEX idx_user_document_like ON us_document_likes(user_id, document_id);
CREATE INDEX idx_user_document_favorite ON us_document_favorites(user_id, document_id);
CREATE INDEX idx_document_comments_parent ON us_document_comments(document_id, parent_id);
CREATE INDEX idx_interaction_stats_document ON us_document_interaction_stats(document_id);
```

---

### 2.5 已完成功能清单 ✅

#### v1 用户系统
- ✅ 用户注册 (`user_register`)
- ✅ 用户认证 (`user_auth`)
- ✅ 用户中心 (`user_profile`)
- ✅ 密码管理 (`password_manager`)

#### v2 文档系统
- ✅ 文档管理 (`document_manager`)
  - 文档CRUD操作
  - 分层级文件夹管理（最多3层）
  - 分页查询
  - 统计功能
- ✅ 文件上传 (`file_upload`)
  - 支持MD、PDF格式上传
  - 文件验证（格式、大小、内容完整性）
  - 上传历史管理
  - 与文档系统集成
  - 统计功能
- ✅ MD编辑器 (`md_editor`)
  - 编辑器会话管理（新建/编辑文档）
  - AI内容优化功能（集成自定义AI服务）
  - 优化历史记录
  - 草稿自动保存
  - 与文档系统深度集成
  - 多种优化模式（通用、语法、结构、扩展）
- ✅ AI审核 (`ai_review`)
  - 文档大小检查（PDF ≤ 10页，MD ≤ 1000行）
  - AI内容安全审核（政治、暴力、色情等）
  - 审核状态管理
  - 审核历史记录
  - 审核统计分析
- ✅ 文档发布 (`document_publish`)
  - **发布流程管理**：文档提交 → AI审核 → 自动发布/拒绝
  - **状态控制**：draft → pending_review → published/review_failed
  - **权限管理**：仅文档所有者可发布和撤回
  - **AI审核集成**：自动调用`ai_review`模块进行内容审核
  - **浏览量统计**：支持文档浏览量跟踪
  - **发布历史**：完整的操作历史记录
  - **精选管理**：支持文档精选标记
  - **统计分析**：个人和全局发布统计
- ✅ 技术广场 (`tech_square`)
  - **文档展示**：已发布文档列表展示（分页、筛选、排序）
  - **智能搜索**：关键词搜索（标题、摘要匹配）
  - **多维度筛选**：文件类型、时间范围、热度排序
  - **推荐算法**：综合时间和热度的智能推荐
  - **统计分析**：分类统计、热门文档、最新文档
  - **浏览量跟踪**：文档浏览量统计和增加
  - **性能优化**：数据库索引优化，支持大数据量查询
  - **公开接口**：无需登录即可浏览已发布内容
- ✅ 互动功能 (`interaction`) 🆕
  - **点赞系统**：防重复点赞、切换式点赞、实时统计更新
  - **收藏系统**：个人收藏夹管理、收藏列表查询、收藏统计
  - **评论系统**：二层评论结构（评论+回复）、评论编辑、软删除
  - **统计功能**：文档互动统计、用户行为统计、数据分析
  - **性能优化**：数据库索引优化、统计缓存机制
  - **权限控制**：用户只能操作自己的评论、收藏等

---

### 2.6 API响应格式测试流程 🆕

#### 2.6.1 问题背景

在开发过程中发现，直接基于假设编写测试脚本容易出现以下问题：
- ❌ API响应格式不明确（`result["id"]` vs `result["data"]["id"]`）
- ❌ 字段位置假设错误
- ❌ 测试脚本与实际API不匹配

#### 2.6.2 解决方案：API响应格式预测试

**在编写正式测试脚本之前，必须先编写API响应格式测试脚本,跟用户获取输出信息，根据这个信息去写正式测试脚本。**

#### 2.6.6 开发规范更新

**强制要求**：
1. ✅ **每个新模块开发完成后，必须先编写API响应格式测试脚本**
2. ✅ **基于真实响应格式编写功能测试脚本**
3. ✅ **禁止基于假设编写测试代码**

**文件命名规范**：
- API响应测试：`api_response_test_{模块名}.py`
- 功能测试：`test_{模块名}_clean.py`

---

### 2.7 测试验证结果 🧪

#### 2.7.1 `interaction` 模块测试结果

```
🚀 开始Interaction模块测试
==================================================
✅ 用户登录成功
✅ 模块连通性正常
✅ 创建测试文档成功 (ID: 45, 标题: 互动测试文档_20251016_161516_vckk)
❌ 文档发布失败: {"detail":[{"type":"missing","loc":["body","document_id"],"msg":"Field required"}]}
✅ 获取初始点赞状态成功 (已点赞: False, 点赞数: 0)
✅ 点赞操作成功 (状态: 点赞成功, 点赞数: 1)
✅ 取消点赞成功 (状态: 取消点赞成功, 点赞数: 0)
✅ 获取初始收藏状态成功 (已收藏: False, 收藏数: 0)
✅ 收藏操作成功 (状态: 收藏成功, 收藏数: 1)
✅ 获取收藏列表成功 (总数: 1)
✅ 创建评论成功 (ID: 1)
✅ 创建回复成功 (ID: 2)
✅ 获取评论列表成功 (总数: 1)
   - 评论回复数: 1
✅ 更新评论成功
✅ 获取文档统计成功
   - 点赞数: 1
   - 收藏数: 0
   - 评论数: 2
✅ 获取用户统计成功
   - 给出点赞: 0
   - 收藏文档: 1
   - 发表评论: 2
   - 收到点赞: 0
   - 收到收藏: 1
   - 收到评论: 2
==================================================
📊 测试完成: 7/7 通过
🎉 所有测试通过! Interaction模块运行正常
```

### 2.8 待开发功能清单 🔄

| 优先级 | 模块 | 功能描述 | 依赖 | 开发流程 |
|--------|------|----------|------|----------|
| 🔴 高 | `share_system` | 分享链接系统：生成链接、权限控制、统计分析 | `interaction` | 1.开发代码 → 2.API响应测试 → 3.功能测试 |

> **模块依赖关系**：`tech_square` ✅ → `interaction` ✅ → `share_system` 🔄

---

## 3. 开发经验总结

### 3.1 重要问题记录与解决方案

#### 3.1.1 数据库配置错误 ⚠️

**问题描述**：
- 初期文档中错误使用了 `fastapi_db` 数据库名
- 实际项目使用的是 `user_system` 数据库

**正确配置**：
```bash
# 正确的数据库信息
DATABASE_URL=mysql+pymysql://root:ljl18420@localhost:3306/user_system

# 正确的连接命令
mysql -u root -p
USE user_system;
```

**经验教训**：
- 开发前必须确认实际的数据库配置
- 文档中的示例要与实际环境保持一致

#### 3.1.2 AI审核服务调用参数错误 🔧

**问题描述**：
```python
# 错误的调用方式
review_result = AIReviewService.submit_document_review(
    db=db,  # 使用了关键字参数
    user_id=publish_record.user_id,
    document_id=publish_record.document_id  # 传递了document_id而不是Document对象
)
```

**错误信息**：
```
AIReviewService.submit_document_review() missing 1 required positional argument: 'db'
AIReviewService.submit_document_review() got an unexpected keyword argument 'document_id'
```

**正确解决方案**：
```python
# 正确的调用方式
from app.modules.v2.ai_review.services import ai_review_service

# 获取Document对象
document = db.query(Document).filter(Document.id == publish_record.document_id).first()

# 使用实例方法调用
review_result = ai_review_service.submit_document_review(
    document,  # Document对象
    publish_record.user_id,  # user_id
    db  # Session对象
)
```

**经验教训**：
- 新模块集成现有服务时，必须先查看现有服务的方法签名
- 不要假设方法参数，要查看实际的代码实现
- 静态方法 vs 实例方法的调用方式不同

#### 3.1.3 API响应格式假设错误 🔄 🆕

**问题描述**：
测试脚本期望的响应格式：
```python
self.test_document_id = result["data"]["id"]  # 期望嵌套结构
```

实际接口返回格式：
```json
{
  "id": 44,
  "title": "API测试文档",
  "status": "draft"
}
```

**解决方案**：
```python
# 修复后的代码
self.test_document_id = result["id"]  # 直接从根级别获取
```

**经验教训**：
- ❌ **禁止基于假设编写测试代码**
- ✅ **必须先测试API响应格式，再编写测试脚本**
- ✅ **建立API响应格式预测试流程**

#### 3.1.4 文档重名问题 📝

**问题描述**：
```
{"detail":"该文件夹下已存在同名文档"}
```

**解决方案**：
```python
def generate_unique_title(self):
    """生成唯一的文档标题"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    random_suffix = ''.join(random.choices(string.ascii_lowercase, k=4))
    return f"测试文档_{timestamp}_{random_suffix}"
```

**经验教训**：
- 测试数据要考虑唯一性约束
- 使用时间戳和随机字符串确保唯一性

#### 3.1.5 SQLAlchemy查询警告 📊 🆕

**问题描述**：
```
SAWarning: Coercing Subquery object into a select() for use in IN()
```

**解决方案**：
```python
# 修复前
user_documents = db.query(Document.id).filter(Document.user_id == user_id).subquery()

# 修复后
from sqlalchemy import select
user_documents_query = select(Document.id).where(Document.user_id == user_id)
```

**经验教训**：
- 使用现代SQLAlchemy语法避免警告
- 关注性能优化和代码质量

### 3.2 开发最佳实践总结

#### 3.2.1 新的模块开发流程 🆕

1. **需求分析** → 确定模块功能和接口设计
2. **数据库设计** → 复用现有表或设计新表结构
3. **代码实现** → 按照标准模块结构开发
4. **API响应格式测试** → 🆕 **编写并运行响应格式测试脚本**
5. **功能测试** → 基于真实响应格式编写完整测试脚本
6. **集成测试** → 确保与现有模块的兼容性
7. **文档更新** → 更新技术文档和接口文档

#### 3.2.2 代码质量保证

- **导入路径规范**：使用相对导入避免模块路径问题
- **错误处理完善**：每个接口都要有完整的异常处理
- **参数验证严格**：使用Pydantic进行严格的参数验证
- **数据库优化**：合理设计索引，优化查询性能
- **API响应一致性**：🆕 **确保响应格式的一致性**

#### 3.2.3 测试策略

- **API响应格式预测试**：🆕 **每个模块必须先测试API响应格式**
- **单元测试**：每个功能点都要有对应的测试用例
- **集成测试**：测试模块间的交互是否正常
- **性能测试**：验证在大数据量下的性能表现
- **错误场景测试**：测试各种异常情况的处理

### 3.3 架构设计经验

#### 3.3.1 模块化设计优势

- ✅ **开发效率高**：新功能只需新建目录，无需修改现有代码
- ✅ **维护成本低**：模块间隔离，问题定位快速
- ✅ **扩展性强**：支持版本化管理，向后兼容
- ✅ **团队协作友好**：不同开发者可以并行开发不同模块
- ✅ **测试流程标准化**：🆕 **统一的API测试流程**

#### 3.3.2 数据库设计经验

- **复用优先**：优先复用现有表结构，减少数据冗余
- **索引优化**：根据查询模式设计合理的索引
- **外键约束**：保证数据一致性和完整性
- **性能考虑**：大数据量场景下的分页和查询优化
- **统计缓存**：🆕 **热点数据使用缓存表提升性能**

#### 3.3.3 API设计经验

- **RESTful规范**：遵循REST API设计原则
- **统一响应格式**：🆕 **所有接口保持一致的响应结构**
- **错误码标准化**：使用标准的HTTP状态码
- **文档完善**：每个接口都要有详细的文档说明
- **响应格式测试**：🆕 **强制要求API响应格式预测试**

---

## 4. 继续开发指南

### 4.1 项目背景信息
---

### 4.3 技术栈和架构信息

#### 后端技术栈
- **框架**：FastAPI
- **数据库**：MySQL 8+ (`user_system`)
- **ORM**：SQLAlchemy
- **认证**：JWT Bearer Token (HS256)
- **AI集成**：自定义AI服务（HTTP API）
- **Python版本**：3.x
- **环境管理**：Anaconda (`xm_3`)

#### 互动功能架构 🆕
- **点赞系统**：防重复点赞 + 切换式操作 + 实时统计
- **收藏系统**：个人收藏夹 + 收藏列表管理
- **评论系统**：二层结构（评论+回复）+ 软删除 + 权限控制
- **统计缓存**：`us_document_interaction_stats` 表提升查询性能
- **性能优化**：复合索引 + 查询优化

---

### 4.4 下一步开发需求

#### 立即开始：`share_system` 模块（最后一个模块）

**功能概述**：
- **分享链接生成**：为文档生成唯一分享链接
- **权限控制**：公开分享/私有分享/密码保护
- **访问统计**：分享链接的访问次数和访问记录
- **链接管理**：分享链接的创建、更新、删除、过期管理

**技术要点**：
- 分享链接的唯一性和安全性
- 权限验证和访问控制
- 访问统计和数据分析
- 与现有模块的深度集成

**开发流程**：
1. **开发模块代码**（models, schemas, services, routes, dependencies）
2. **🆕 编写API响应格式测试脚本**
3. **🆕 运行响应格式测试，分析真实API响应**
4. **基于真实响应格式编写功能测试脚本**
5. **运行完整功能测试**
6. **更新技术文档**

---

## 5. 快速启动命令

### 5.1 环境启动

```bash
# 激活Python环境
conda activate xm_3

# 启动FastAPI应用
cd fastapi
python -m uvicorn app.main:app --host 0.0.0.0 --port 8100 --reload
```

### 5.2 数据库连接

```bash
# 连接MySQL数据库
mysql -u root -p
# 密码：ljl18420

# 使用项目数据库
USE user_system;

# 查看所有表
SHOW TABLES;
```

### 5.3 测试命令

```bash
# 运行互动功能模块测试
cd fastapi/测试脚本/v2测试脚本
python test_interaction_clean.py

# 运行API响应格式测试（新模块开发时使用）
cd fastapi/测试脚本
python api_response_test.py

# 测试登录接口
curl -X POST "http://localhost:8100/api/v1/user_auth/login" \
-H "Content-Type: application/json" \
-d '{"username_or_email":"abc","password":"ljl18420"}'

# 测试互动功能接口
curl -X POST "http://localhost:8100/api/v2/interaction/documents/45/like" \
-H "Authorization: Bearer YOUR_TOKEN"
```


---

## 📊 项目完成度总览

```
项目进度：██████████████████████████████████████████████████ 90% (9/10)

✅ 已完成模块：
├── v1/user_register      ✅ 用户注册
├── v1/user_auth          ✅ 用户认证
├── v1/user_profile       ✅ 用户中心
├── v1/password_manager   ✅ 密码管理
├── v2/document_manager   ✅ 文档管理
├── v2/file_upload        ✅ 文件上传
├── v2/md_editor          ✅ MD编辑器
├── v2/ai_review          ✅ AI审核
├── v2/document_publish   ✅ 文档发布
├── v2/tech_square        ✅ 技术广场
└── v2/interaction        ✅ 互动功能 🆕

🔄 待开发模块：
└── v2/share_system       🔄 分享系统（最后一个模块）
```

---

**🎯 准备好开发最后一个模块 `share_system` 了吗？**

**新的开发流程**：
1. 开发模块代码
2. 🆕 **API响应格式测试**
3. 🆕 **基于真实响应编写测试脚本**
4. 功能测试验证
5. 文档更新
