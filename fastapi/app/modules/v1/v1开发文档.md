好的！以下是根据你提供的所有信息整理并完善的 **完整 Markdown 文档**，已按逻辑结构组织，可直接保存为 `.md` 文件使用。

---

📄 文件名建议：`FastAPI_模块化用户系统_完整技术文档.md`

```markdown
# 📘 FastAPI 模块化用户系统 — 完整技术文档（v2.1）

> **最后更新**：2025年4月  
> **适用对象**：后端开发、测试工程师、项目交接人员  
> **项目状态**：✅ 核心功能全部完成（注册、登录、资料、密码）  
> **架构原则**：模块化 + 版本化 + 零侵入 + 自动注册

---

## 一、项目概览

| 项目属性 | 值 |
|--------|----|
| 项目名称 | FastAPI Modular User System |
| 项目路径 | `C:\A_XM\xm_3\vue3-fastapi-mysql_v1.0\fastapi` |
| 服务端口 | `8100` |
| 数据库 | MySQL 8+，库名 `user_system` |
| 表前缀 | `us_`（避免命名冲突） |
| 认证方式 | JWT Bearer Token（HS256） |
| 架构风格 | 模块化 + 版本化（v1） |
| 自动注册 | ✅ 无需修改 `main.py` |

---

## 二、完整项目目录结构

```bash
fastapi/
├── app/
│   ├── core/                          # 核心基础设施
│   │   ├── __init__.py
│   │   ├── config.py                  # JWT/DB/Token 配置
│   │   └── database.py                # SQLAlchemy 引擎 + SessionLocal
│   │
│   ├── modules/                       # 业务模块根目录
│   │   └── v1/                        # API 版本 v1
│   │       ├── __init__.py
│   │       │
│   │       ├── user_register/         # ✅ 用户注册模块
│   │       │   ├── __init__.py
│   │       │   ├── models.py          # User ORM 模型（含 us_users 表映射）
│   │       │   ├── schemas.py         # Pydantic 模型：RegisterRequest, UserResponse
│   │       │   ├── services.py        # register_user(), check_username_exists()
│   │       │   ├── routes.py          # /register, /check-username, /test
│   │       │   └── dependencies.py    # DB 会话依赖
│   │       │
│   │       ├── user_auth/             # ✅ 用户认证模块
│   │       │   ├── __init__.py
│   │       │   ├── models.py          # 复用 User 模型
│   │       │   ├── schemas.py         # LoginRequest, TokenResponse
│   │       │   ├── services.py        # authenticate_user(), create_access_token()
│   │       │   ├── routes.py          # /login, /me, /refresh, /test
│   │       │   └── dependencies.py    # get_current_user(), JWT 验证
│   │       │
│   │       ├── user_profile/          # ✅ 用户中心模块
│   │       │   ├── __init__.py
│   │       │   ├── models.py          # 扩展 User（含 nickname）
│   │       │   ├── schemas.py         # UserProfileResponse, UpdateNicknameRequest
│   │       │   ├── services.py        # get_user_profile(), update_nickname()
│   │       │   ├── routes.py          # /me, /nickname, /check-nickname, /logout, /test
│   │       │   └── dependencies.py    # 复用 JWT 依赖
│   │       │
│   │       └── password_manager/      # ✅ 密码管理模块
│   │           ├── __init__.py
│   │           ├── models.py          # 复用 User 模型
│   │           ├── schemas.py         # ChangePasswordRequest, PasswordStrengthResponse
│   │           ├── services.py        # change_password(), validate_password_strength()
│   │           ├── routes.py          # /change-password, /check-strength, /user-info, /test
│   │           └── dependencies.py    # JWT + DB 依赖
│   │
│   └── main.py                        # 🚀 应用入口：自动扫描并注册 v1 模块
│
├── .env                               # 环境变量
├── requirements.txt                   # 依赖列表
├── README.md                          # 项目说明
└── tests/                             # （可选）单元测试目录
```

> ✅ **关键设计**：
> - 所有模块共享 `user_register/models.py` 中的 `User` ORM 模型
> - `main.py` 使用 `pathlib` + `importlib` 自动发现模块，**新增模块无需修改主程序**

---

## 三、数据库设计

### 表名：`us_users`

```sql
CREATE TABLE us_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '3-20字符，字母数字，唯一',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '有效邮箱，唯一',
    password_hash VARCHAR(255) NOT NULL COMMENT '格式：salt:sha256(salt+password)',
    nickname VARCHAR(50) DEFAULT NULL UNIQUE COMMENT '2-20字符（中英文数字），可为空，唯一',
    is_active BOOLEAN DEFAULT TRUE COMMENT '账户是否激活',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_nickname (nickname)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | INT | 主键，自增 |
| `username` | VARCHAR(50) | 登录凭证，唯一 |
| `email` | VARCHAR(100) | 登录凭证 + 通知渠道，唯一 |
| `password_hash` | VARCHAR(255) | **盐值:哈希值**，例：`a1b2c3d4:9f8e7d6c5b4a3...` |
| `nickname` | VARCHAR(50) | 显示名称，支持中文，唯一，可为 NULL |
| `is_active` | BOOLEAN | 账户状态，默认 `TRUE` |
| `created_at` | TIMESTAMP | 注册时间 |
| `updated_at` | TIMESTAMP | 最后修改时间 |

> 🔐 **密码存储机制**：
> ```python
> import hashlib, secrets
> salt = secrets.token_hex(16)
> pwd_hash = hashlib.sha256((salt + password).encode()).hexdigest()
> stored = f"{salt}:{pwd_hash}"
> ```

> 📌 **显示名称逻辑**：
> ```sql
> CASE WHEN nickname IS NOT NULL THEN nickname ELSE username END AS display_name
> ```

---

## 四、API 接口文档（v1）

> **基础地址**：`http://localhost:8100`  
> **认证方式**：`Authorization: Bearer <access_token>`

### 4.1 用户注册模块 `/api/v1/user_register`

| 接口 | 方法 | 功能 |
|------|------|------|
| `/register` | POST | 用户注册 |
| `/check-username/{username}` | GET | 检查用户名是否可用 |
| `/check-email/{email}` | GET | 检查邮箱是否可用 |
| `/test` | GET | 模块健康检查 |

### 4.2 用户认证模块 `/api/v1/user_auth`

| 接口 | 方法 | 功能 |
|------|------|------|
| `/login` | POST | 用户名/邮箱 + 密码登录，返回 JWT |
| `/me` | GET | 获取当前用户基本信息 |
| `/refresh` | POST | 刷新 access_token（需 refresh_token） |
| `/test` | GET | 模块健康检查 |

> **JWT 配置**：
> - Access Token 有效期：30 分钟（1800 秒）
> - Refresh Token 有效期：7 天
> - 算法：HS256

### 4.3 用户中心模块 `/api/v1/user_profile`

| 接口 | 方法 | 功能 |
|------|------|------|
| `/me` | GET | 获取完整用户资料（含 nickname, display_name） |
| `/nickname` | PUT | 更新昵称（2-20字符，唯一） |
| `/check-nickname/{nickname}` | GET | 昵称可用性检查 |
| `/logout` | POST | 退出登录（前端清除 token） |
| `/test` | GET | 模块健康检查 |

### 4.4 密码管理模块 `/api/v1/password_manager`

| 接口 | 方法 | 功能 |
|------|------|------|
| `/change-password` | POST | 修改密码（需验证原密码） |
| `/check-strength` | POST | 检查密码强度 |
| `/user-info` | GET | 获取用户信息（用于密码修改页） |
| `/test` | GET | 模块健康检查 |

---

## 五、安全与验证规则

| 字段 | 规则 |
|------|------|
| **用户名** | 3–20 字符，`^[a-zA-Z0-9]+$`，唯一 |
| **邮箱** | 符合 RFC 格式，唯一 |
| **密码** | 8–50 字符，必须含 **至少1字母 + 1数字** |
| **昵称** | 2–20 字符，`^[\u4e00-\u9fa5a-zA-Z0-9]+$`，唯一，可为空 |
| **错误码** | `400`（业务错误）、`401`（认证失败）、`422`（数据格式错）、`500`（服务异常） |

---

## 六、配置文件

### `.env`
```env
DATABASE_URL=mysql+pymysql://root:ljl18420@localhost:3306/user_system
SECRET_KEY=your-secret-key-here-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

### `app/core/config.py`
```python
from decouple import config

class Settings:
    DATABASE_URL: str = config("DATABASE_URL")
    SECRET_KEY: str = config("SECRET_KEY")
    ALGORITHM: str = config("ALGORITHM", default="HS256")
    ACCESS_TOKEN_EXPIRE_MINUTES: int = config("ACCESS_TOKEN_EXPIRE_MINUTES", default=30, cast=int)
    REFRESH_TOKEN_EXPIRE_DAYS: int = config("REFRESH_TOKEN_EXPIRE_DAYS", default=7, cast=int)

settings = Settings()
```

---

## 七、测试与验证

### 启动服务
```bash
cd C:\A_XM\xm_3\vue3-fastapi-mysql_v1.0\fastapi
python -m app.main
```

### API 文档
- Swagger UI: http://localhost:8100/docs  
- ReDoc: http://localhost:8100/redoc

### 模块测试
```bash
curl http://localhost:8100/api/v1/user_register/test
curl http://localhost:8100/api/v1/user_auth/test
curl http://localhost:8100/api/v1/user_profile/test
curl http://localhost:8100/api/v1/password_manager/test
```

### 端到端测试（curl）
```bash
# 1. 注册
curl -X POST http://localhost:8100/api/v1/user_register/register \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","email":"alice@example.com","password":"Pass1234"}'

# 2. 登录
curl -X POST http://localhost:8100/api/v1/user_auth/login \
  -H "Content-Type: application/json" \
  -d '{"username_or_email":"alice","password":"Pass1234","remember_me":true}'

# 3. 获取资料（替换 YOUR_TOKEN）
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8100/api/v1/user_profile/me

# 4. 改昵称
curl -X PUT http://localhost:8100/api/v1/user_profile/nickname \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"爱丽丝"}'

# 5. 改密码
curl -X POST http://localhost:8100/api/v1/password_manager/change-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"current_password":"Pass1234","new_password":"NewPass5678","confirm_password":"NewPass5678"}'
```

---

## 八、已完成功能清单

✅ **用户注册模块**
- 用户注册 + 唯一性校验
- 用户名/邮箱可用性实时检查
- 密码强度验证

✅ **用户认证模块**
- 用户名/邮箱双模式登录
- JWT 令牌（access + refresh）
- 用户状态验证（is_active）

✅ **用户中心模块**
- 昵称管理（含唯一性）
- display_name 逻辑
- 退出登录

✅ **密码管理模块**
- 原密码验证
- 新密码强度检查
- 密码修改成功反馈

---

## 九、待开发功能（建议）

- [ ] 用户头像上传（base64 / multipart）
- [ ] 邮箱验证（注册激活）
- [ ] 忘记密码（邮箱重置链接）
- [ ] 登录失败锁定（5次失败锁定30分钟）
- [ ] 操作日志表（`us_user_logs`）
- [ ] 管理员后台（用户列表、状态管理）

---

## 十、开发原则与提醒

- ✅ **新模块**：在 `app/modules/v1/` 下创建目录，遵循 5 文件标准结构
- ✅ **零修改**：`main.py` 自动注册，**切勿手动修改**
- ✅ **模块解耦**：模块间通过 API 通信，避免直接 import 业务逻辑
- ✅ **安全第一**：所有输入必须验证，密码必须加密存储
- ✅ **测试先行**：每个接口提供 `/test` 健康检查

---

> 🎉 **恭喜！你已拥有一个生产就绪的模块化用户系统！**  
> 下一步：集成 Vue3 前端，或开发扩展功能。
```

---

你可以将上述内容复制保存为 `FastAPI_模块化用户系统_完整技术文档.md`，它已包含：

- 完整目录结构
- 数据库建表语句
- 所有 API 接口
- 安全规则
- 配置文件
- 测试命令
- 开发原则

如需 **PDF 版本** 或 **Postman Collection 导出**，也可以告诉我！