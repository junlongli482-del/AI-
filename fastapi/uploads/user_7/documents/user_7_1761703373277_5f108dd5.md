 # ğŸ“˜ 06-æ–‡ä»¶ä¸Šä¼ æ¨¡å—.md

> **æ¨¡å—è·¯å¾„**ï¼š`/api/v2/file_upload`  
> **è®¤è¯è¦æ±‚**ï¼šâœ… éœ€è¦Bearer Token  
> **æ¥å£æ•°é‡**ï¼š8ä¸ª

---

## ğŸ” æ¥å£æ€»è§ˆ

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|------|
| æ¨¡å—æµ‹è¯• | GET | `/test` | æ¨¡å—å¥åº·æ£€æŸ¥ | âŒ |
| ä¸Šä¼ é…ç½® | GET | `/config` | è·å–ä¸Šä¼ é…ç½®ä¿¡æ¯ | âŒ |
| æ–‡ä»¶éªŒè¯ | POST | `/validate` | ä»…éªŒè¯æ–‡ä»¶ä¸ä¿å­˜ | âœ… |
| æ–‡ä»¶ä¸Šä¼  | POST | `/upload` | ä¸Šä¼ å¹¶ä¿å­˜æ–‡ä»¶ | âœ… |
| ä¸Šä¼ å†å² | GET | `/uploads` | è·å–ä¸Šä¼ å†å²è®°å½• | âœ… |
| ä¸Šä¼ è¯¦æƒ… | GET | `/uploads/{upload_id}` | è·å–å•ä¸ªä¸Šä¼ è®°å½•è¯¦æƒ… | âœ… |
| åˆ›å»ºæ–‡æ¡£ | POST | `/create-document` | ä»ä¸Šä¼ æ–‡ä»¶åˆ›å»ºæ–‡æ¡£ | âœ… |
| åˆ é™¤è®°å½• | DELETE | `/uploads/{upload_id}` | åˆ é™¤ä¸Šä¼ è®°å½• | âœ… |
| ç»Ÿè®¡ä¿¡æ¯ | GET | `/stats` | è·å–ç”¨æˆ·ä¸Šä¼ ç»Ÿè®¡ | âœ… |

---

## ğŸ“‹ æ¥å£è¯¦æƒ…

### 1. æ¨¡å—æµ‹è¯•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/file_upload/test
```

**æˆåŠŸå“åº” (200)**
```json
{
  "message": "æ–‡ä»¶ä¸Šä¼ æ¨¡å—è¿è¡Œæ­£å¸¸",
  "module": "file_upload"
}
```

---

### 2. è·å–ä¸Šä¼ é…ç½®

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/file_upload/config
```

**æˆåŠŸå“åº” (200)**
```json
{
  "max_file_size_mb": 50,
  "allowed_extensions": [".md", ".pdf"],
  "upload_path": "uploads"
}
```

---

### 3. æ–‡ä»¶éªŒè¯

**æ¥å£ä¿¡æ¯**
```
POST /api/v2/file_upload/validate
Content-Type: multipart/form-data
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```
file: è¦éªŒè¯çš„æ–‡ä»¶ï¼ˆform-dataæ ¼å¼ï¼‰
```

**éªŒè¯è§„åˆ™**
- **æ–‡ä»¶ç±»å‹**ï¼šä»…æ”¯æŒ `.md` å’Œ `.pdf`
- **æ–‡ä»¶å¤§å°**ï¼šMDæ–‡ä»¶æœ€å¤§20MBï¼ŒPDFæ–‡ä»¶æœ€å¤§100MB
- **æ–‡ä»¶å®Œæ•´æ€§**ï¼šéªŒè¯æ–‡ä»¶å¤´å’Œå†…å®¹å®Œæ•´æ€§
- **å†…å®¹é™åˆ¶**ï¼šPDFæœ€å¤š20é¡µï¼ŒMDæ–‡æ¡£æœ€å¤šç›¸å½“äº20é¡µA4çº¸

**æˆåŠŸå“åº” (200)**
```json
{
  "is_valid": true,
  "file_type": "md",
  "file_size": 2048,
  "validation_details": {
    "signature_check": {
      "is_valid": true
    },
    "content_check": {
      "is_valid": true,
      "char_count": 1500,
      "line_count": 45,
      "estimated_pages": 0.8
    }
  },
  "error_message": null
}
```

**éªŒè¯å¤±è´¥å“åº” (200)**
```json
{
  "is_valid": false,
  "file_type": "pdf",
  "file_size": 5242880,
  "validation_details": {},
  "error_message": "PDFæ–‡ä»¶é¡µæ•°è¶…å‡ºé™åˆ¶ï¼Œå½“å‰25é¡µï¼Œæœ€å¤šå…è®¸20é¡µ"
}
```

---

### 4. æ–‡ä»¶ä¸Šä¼ 

**æ¥å£ä¿¡æ¯**
```
POST /api/v2/file_upload/upload
Content-Type: multipart/form-data
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```
file: è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆform-dataæ ¼å¼ï¼‰
```

**æˆåŠŸå“åº” (200)**
```json
{
  "success": true,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "upload_id": 123,
  "file_info": {
    "original_filename": "fastapi-guide.md",
    "file_size": 2048,
    "file_type": "md",
    "validation_details": {
      "signature_check": {"is_valid": true},
      "content_check": {
        "is_valid": true,
        "char_count": 1500,
        "estimated_pages": 0.8
      }
    }
  }
}
```

**å¤±è´¥å“åº” (200)**
```json
{
  "success": false,
  "message": "æ–‡ä»¶éªŒè¯å¤±è´¥: ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹",
  "upload_id": null,
  "file_info": {}
}
```

---

### 5. è·å–ä¸Šä¼ å†å²

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/file_upload/uploads?page=1&page_size=20&status_filter=validated
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼Œæœ€å°1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼ŒèŒƒå›´1-100ï¼‰
- `status_filter`: çŠ¶æ€ç­›é€‰ï¼ˆå¯é€‰ï¼‰
  - `uploading`: ä¸Šä¼ ä¸­
  - `uploaded`: å·²ä¸Šä¼ 
  - `validated`: å·²éªŒè¯
  - `failed`: å¤±è´¥
  - `deleted`: å·²åˆ é™¤

**æˆåŠŸå“åº” (200)**
```json
{
  "files": [
    {
      "id": 123,
      "original_filename": "fastapi-guide.md",
      "file_size": 2048,
      "file_type": "md",
      "status": "validated",
      "validation_message": "æ–‡ä»¶éªŒè¯é€šè¿‡",
      "created_at": "2024-01-01T10:00:00",
      "updated_at": "2024-01-01T10:00:00"
    }
  ],
  "total": 25,
  "page": 1,
  "page_size": 20,
  "total_pages": 2
}
```

---

### 6. è·å–ä¸Šä¼ è¯¦æƒ…

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/file_upload/uploads/{upload_id}
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "id": 123,
  "original_filename": "fastapi-guide.md",
  "file_size": 2048,
  "file_type": "md",
  "status": "validated",
  "validation_message": "æ–‡ä»¶éªŒè¯é€šè¿‡",
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T10:00:00"
}
```

**é”™è¯¯å“åº”**
```json
// 404 - è®°å½•ä¸å­˜åœ¨
{
  "detail": "æœªæ‰¾åˆ°æŒ‡å®šçš„ä¸Šä¼ è®°å½•"
}
```

---

### 7. ä»ä¸Šä¼ æ–‡ä»¶åˆ›å»ºæ–‡æ¡£

**æ¥å£ä¿¡æ¯**
```
POST /api/v2/file_upload/create-document
Content-Type: application/json
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```json
{
  "upload_id": 123,                    // ä¸Šä¼ è®°å½•ID
  "title": "FastAPIå¼€å‘æŒ‡å—",          // æ–‡æ¡£æ ‡é¢˜
  "summary": "FastAPIæ¡†æ¶æ•™ç¨‹",        // æ–‡æ¡£æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
  "folder_id": 1                       // æ–‡ä»¶å¤¹IDï¼ˆå¯é€‰ï¼‰
}
```

**æˆåŠŸå“åº” (200)**
```json
{
  "success": true,
  "message": "æ–‡æ¡£åˆ›å»ºæˆåŠŸ",
  "document_id": 456,
  "upload_id": 123
}
```

**é”™è¯¯å“åº”**
```json
// 404 - ä¸Šä¼ è®°å½•ä¸å­˜åœ¨
{
  "detail": "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¼ è®°å½•"
}
```

---

### 8. åˆ é™¤ä¸Šä¼ è®°å½•

**æ¥å£ä¿¡æ¯**
```
DELETE /api/v2/file_upload/uploads/{upload_id}
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "success": true,
  "message": "ä¸Šä¼ è®°å½•å·²åˆ é™¤",
  "upload_id": 123
}
```

**é”™è¯¯å“åº”**
```json
// 400 - å·²å…³è”æ–‡æ¡£
{
  "detail": "è¯¥ä¸Šä¼ è®°å½•å·²å…³è”æ–‡æ¡£ï¼Œæ— æ³•åˆ é™¤"
}

// 404 - è®°å½•ä¸å­˜åœ¨
{
  "detail": "æœªæ‰¾åˆ°æŒ‡å®šçš„ä¸Šä¼ è®°å½•"
}
```

---

### 9. è·å–ç»Ÿè®¡ä¿¡æ¯

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/file_upload/stats
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "total_uploads": 25,
  "total_size_bytes": 52428800,
  "total_size_mb": 50.0,
  "status_distribution": {
    "validated": 20,
    "failed": 3,
    "deleted": 2
  },
  "type_distribution": [
    {
      "file_type": "md",
      "count": 18,
      "total_size_bytes": 10485760,
      "total_size_mb": 10.0
    },
    {
      "file_type": "pdf",
      "count": 7,
      "total_size_bytes": 41943040,
      "total_size_mb": 40.0
    }
  ]
}
```

---

## ğŸš¨ é”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ | å¸¸è§åŸå›  |
|--------|------|----------|
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€æ–‡ä»¶è¿‡å¤§ã€å·²å…³è”æ–‡æ¡£ |
| 401 | è®¤è¯å¤±è´¥ | Tokenæ— æ•ˆã€ç”¨æˆ·ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨ |
| 404 | èµ„æºä¸å­˜åœ¨ | ä¸Šä¼ è®°å½•ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—® |
| 422 | æ•°æ®éªŒè¯å¤±è´¥ | å‚æ•°æ ¼å¼é”™è¯¯ã€å¿…å¡«å­—æ®µç¼ºå¤± |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ã€æ•°æ®åº“å¼‚å¸¸ |

---

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### æ–‡ä»¶ç±»å‹æ”¯æŒ
- **Markdownæ–‡ä»¶** (`.md`)
  - æœ€å¤§20MB
  - å¿…é¡»UTF-8ç¼–ç 
  - æœ€å¤šç›¸å½“äº20é¡µA4çº¸å†…å®¹
  
- **PDFæ–‡ä»¶** (`.pdf`)
  - æœ€å¤§100MB
  - æœ€å¤š20é¡µ
  - è‡ªåŠ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§

### ä¸Šä¼ æµç¨‹
1. **é¢„éªŒè¯**ï¼šä½¿ç”¨`/validate`æ¥å£æ£€æŸ¥æ–‡ä»¶
2. **æ­£å¼ä¸Šä¼ **ï¼šä½¿ç”¨`/upload`æ¥å£ä¸Šä¼ æ–‡ä»¶
3. **åˆ›å»ºæ–‡æ¡£**ï¼šä½¿ç”¨`/create-document`ä»ä¸Šä¼ æ–‡ä»¶åˆ›å»ºæ–‡æ¡£

### æ–‡ä»¶å­˜å‚¨
- **å­˜å‚¨è·¯å¾„**ï¼š`uploads/user_{user_id}/documents/`
- **æ–‡ä»¶å‘½å**ï¼š`user_{user_id}_{timestamp}_{uuid}.{ext}`
- **çŠ¶æ€ç®¡ç†**ï¼šä¸Šä¼ ä¸­â†’å·²ä¸Šä¼ â†’å·²éªŒè¯â†’å·²å…³è”æ–‡æ¡£

### çŠ¶æ€è¯´æ˜
- `uploading`: æ–‡ä»¶ä¸Šä¼ ä¸­
- `uploaded`: æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- `validated`: æ–‡ä»¶éªŒè¯é€šè¿‡
- `failed`: ä¸Šä¼ æˆ–éªŒè¯å¤±è´¥
- `deleted`: è®°å½•å·²æ ‡è®°åˆ é™¤

---

## ğŸ¯ å‰ç«¯é›†æˆå»ºè®®

### æ–‡ä»¶ä¸Šä¼ ç»„ä»¶
```javascript
// 1. è·å–ä¸Šä¼ é…ç½®
const config = await fetch('/api/v2/file_upload/config');

// 2. é¢„éªŒè¯æ–‡ä»¶
const formData = new FormData();
formData.append('file', file);
const validation = await fetch('/api/v2/file_upload/validate', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});

// 3. æ­£å¼ä¸Šä¼ 
if (validation.is_valid) {
  const upload = await fetch('/api/v2/file_upload/upload', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  });
}
```

### ä¸Šä¼ å†å²é¡µé¢
```javascript
// è·å–ä¸Šä¼ å†å²
const history = await fetch('/api/v2/file_upload/uploads?page=1&page_size=20', {
  headers: { 'Authorization': `Bearer ${token}` }
});

// è·å–ç»Ÿè®¡ä¿¡æ¯
const stats = await fetch('/api/v2/file_upload/stats', {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

### åˆ›å»ºæ–‡æ¡£
```javascript
// ä»ä¸Šä¼ æ–‡ä»¶åˆ›å»ºæ–‡æ¡£
const createDoc = await fetch('/api/v2/file_upload/create-document', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    upload_id: 123,
    title: 'æ–‡æ¡£æ ‡é¢˜',
    summary: 'æ–‡æ¡£æ‘˜è¦',
    folder_id: 1
  })
});
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0 | **æ›´æ–°æ—¶é—´**ï¼š2024-12-19 | **æ¥å£æ€»æ•°**ï¼š8ä¸ª ğŸ“
