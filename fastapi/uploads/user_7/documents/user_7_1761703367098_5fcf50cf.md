# ğŸ“˜ 05-æ–‡æ¡£ç®¡ç†æ¨¡å—.md

> **æ¨¡å—è·¯å¾„**ï¼š`/api/v2/document_manager`  
> **è®¤è¯è¦æ±‚**ï¼šâœ… éœ€è¦Bearer Token  
> **æ¥å£æ•°é‡**ï¼š11ä¸ª

---

## ğŸ” æ¥å£æ€»è§ˆ

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|------|
| æ¨¡å—æµ‹è¯• | GET | `/test` | æ¨¡å—å¥åº·æ£€æŸ¥ | âŒ |
| åˆ›å»ºæ–‡ä»¶å¤¹ | POST | `/folders` | åˆ›å»ºæ–°æ–‡ä»¶å¤¹ | âœ… |
| è·å–æ–‡ä»¶å¤¹æ ‘ | GET | `/folders/tree` | è·å–æ–‡ä»¶å¤¹æ ‘å½¢ç»“æ„ | âœ… |
| åˆ é™¤æ–‡ä»¶å¤¹ | DELETE | `/folders/{folder_id}` | åˆ é™¤ç©ºæ–‡ä»¶å¤¹ | âœ… |
| åˆ›å»ºæ–‡æ¡£ | POST | `/documents` | åˆ›å»ºæ–°æ–‡æ¡£ | âœ… |
| è·å–æ–‡æ¡£è¯¦æƒ… | GET | `/documents/{doc_id}` | è·å–å•ä¸ªæ–‡æ¡£è¯¦æƒ… | âœ… |
| æ›´æ–°æ–‡æ¡£ | PUT | `/documents/{doc_id}` | æ›´æ–°æ–‡æ¡£ä¿¡æ¯ | âœ… |
| åˆ é™¤æ–‡æ¡£ | DELETE | `/documents/{doc_id}` | åˆ é™¤æ–‡æ¡£ | âœ… |
| è·å–æ–‡æ¡£åˆ—è¡¨ | GET | `/documents` | è·å–æ–‡æ¡£åˆ—è¡¨(åˆ†é¡µ) | âœ… |
| è·å–ç»Ÿè®¡ä¿¡æ¯ | GET | `/stats` | è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ | âœ… |
| **ä¸‹è½½æ–‡æ¡£æ–‡ä»¶** | **GET** | **`/documents/{doc_id}/download`** | **ä¸‹è½½æ–‡æ¡£æ–‡ä»¶** | **âœ…** |
| **æµå¼ä¼ è¾“æ–‡æ¡£** | **GET** | **`/documents/{doc_id}/stream`** | **æµå¼ä¼ è¾“æ–‡æ¡£ï¼ˆPDFé¢„è§ˆï¼‰** | **âœ…** |
| **è·å–æ–‡ä»¶ä¿¡æ¯** | **GET** | **`/documents/{doc_id}/info`** | **è·å–æ–‡æ¡£æ–‡ä»¶ä¿¡æ¯** | **âœ…** |

---

## ğŸ“‹ æ¥å£è¯¦æƒ…

### 1. æ¨¡å—æµ‹è¯•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/test
```

**æˆåŠŸå“åº” (200)**
```json
{
  "message": "Document Manageræ¨¡å—è¿è¡Œæ­£å¸¸",
  "version": "v2.0",
  "features": ["æ–‡æ¡£ç®¡ç†", "æ–‡ä»¶å¤¹ç®¡ç†", "åˆ†é¡µæŸ¥è¯¢"]
}
```

---

### 2. åˆ›å»ºæ–‡ä»¶å¤¹

**æ¥å£ä¿¡æ¯**
```
POST /api/v2/document_manager/folders
Content-Type: application/json
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```json
{
  "name": "string",           // æ–‡ä»¶å¤¹åç§°ï¼ˆ1-100å­—ç¬¦ï¼‰
  "parent_id": 1              // çˆ¶æ–‡ä»¶å¤¹IDï¼ˆå¯é€‰ï¼Œä¸å¡«è¡¨ç¤ºæ ¹ç›®å½•ï¼‰
}
```

**å‚æ•°éªŒè¯**
- `name`: å¿…å¡«ï¼Œä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼š`/ \ : * ? " < > |`
- `parent_id`: å¯é€‰ï¼ŒæŒ‡å®šçˆ¶æ–‡ä»¶å¤¹ID

**æˆåŠŸå“åº” (200)**
```json
{
  "id": 1,
  "name": "æŠ€æœ¯æ–‡æ¡£",
  "parent_id": null,
  "level": 1,
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T10:00:00"
}
```

**é”™è¯¯å“åº”**
```json
// 400 - åŒåæ–‡ä»¶å¤¹
{
  "detail": "è¯¥ä½ç½®å·²å­˜åœ¨åŒåæ–‡ä»¶å¤¹"
}

// 400 - å±‚çº§é™åˆ¶
{
  "detail": "æ–‡ä»¶å¤¹å±‚çº§ä¸èƒ½è¶…è¿‡3å±‚"
}

// 404 - çˆ¶æ–‡ä»¶å¤¹ä¸å­˜åœ¨
{
  "detail": "çˆ¶æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
}
```

---

### 3. è·å–æ–‡ä»¶å¤¹æ ‘

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/folders/tree
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
[
  {
    "id": 1,
    "name": "æŠ€æœ¯æ–‡æ¡£",
    "level": 1,
    "document_count": 5,
    "children": [
      {
        "id": 2,
        "name": "å‰ç«¯å¼€å‘",
        "level": 2,
        "document_count": 3,
        "children": []
      }
    ]
  }
]
```

---

### 4. åˆ é™¤æ–‡ä»¶å¤¹

**æ¥å£ä¿¡æ¯**
```
DELETE /api/v2/document_manager/folders/{folder_id}
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "success": true,
  "message": "æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ",
  "data": null
}
```

**é”™è¯¯å“åº”**
```json
// 400 - æ–‡ä»¶å¤¹ä¸ä¸ºç©º
{
  "detail": "æ–‡ä»¶å¤¹ä¸ä¸ºç©ºï¼Œæ— æ³•åˆ é™¤ã€‚è¯·å…ˆåˆ é™¤å­æ–‡ä»¶å¤¹å’Œæ–‡æ¡£"
}

// 404 - æ–‡ä»¶å¤¹ä¸å­˜åœ¨
{
  "detail": "æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
}
```

---

### 5. åˆ›å»ºæ–‡æ¡£

**æ¥å£ä¿¡æ¯**
```
POST /api/v2/document_manager/documents
Content-Type: application/json
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```json
{
  "title": "string",          // æ–‡æ¡£æ ‡é¢˜ï¼ˆ1-200å­—ç¬¦ï¼‰
  "content": "string",        // æ–‡æ¡£å†…å®¹ï¼ˆMDæ ¼å¼ï¼Œå¯é€‰ï¼‰
  "summary": "string",        // ç®€çŸ­æ‘˜è¦ï¼ˆæœ€å¤š500å­—ç¬¦ï¼Œå¯é€‰ï¼‰
  "folder_id": 1,             // æ‰€å±æ–‡ä»¶å¤¹IDï¼ˆå¯é€‰ï¼‰
  "file_type": "md"           // æ–‡ä»¶ç±»å‹ï¼šmdæˆ–pdfï¼Œé»˜è®¤md
}
```

**æˆåŠŸå“åº” (200)**
```json
{
  "id": 1,
  "title": "FastAPIå¼€å‘æŒ‡å—",
  "content": "# FastAPIå¼€å‘æŒ‡å—\n\nè¿™æ˜¯ä¸€ä¸ª...",
  "file_path": null,
  "file_type": "md",
  "file_size": 1024,
  "summary": "FastAPIæ¡†æ¶çš„åŸºç¡€ä½¿ç”¨æ•™ç¨‹",
  "status": "draft",
  
  // ğŸ†• æ–°å¢çŠ¶æ€å­—æ®µ
  "publish_status": null,
  "content_status": "draft",
  "has_published_version": false,
  
  "publish_time": null,
  "review_message": null,
  "folder_id": 1,
  "folder_name": "æŠ€æœ¯æ–‡æ¡£",
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T10:00:00"
}
```

**é”™è¯¯å“åº”**
```json
// 400 - åŒåæ–‡æ¡£
{
  "detail": "è¯¥æ–‡ä»¶å¤¹ä¸‹å·²å­˜åœ¨åŒåæ–‡æ¡£"
}

// 404 - æ–‡ä»¶å¤¹ä¸å­˜åœ¨
{
  "detail": "æŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
}
```

---

### 6. è·å–æ–‡æ¡£è¯¦æƒ… ğŸ†•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/documents/{doc_id}
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "id": 1,
  "title": "FastAPIå¼€å‘æŒ‡å—",
  "content": "# FastAPIå¼€å‘æŒ‡å—\n\nè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•™ç¨‹...",
  "file_path": null,
  "file_type": "md",
  "file_size": 2048,
  "summary": "FastAPIæ¡†æ¶çš„åŸºç¡€ä½¿ç”¨æ•™ç¨‹",
  "status": "published",
  
  // ğŸ†• æ–°å¢çŠ¶æ€å­—æ®µ - è§£å†³çŠ¶æ€æ··ä¹±é—®é¢˜
  "publish_status": "published",      // æŠ€æœ¯å¹¿åœºçŠ¶æ€
  "content_status": "review_failed",  // æœ€æ–°å†…å®¹çŠ¶æ€
  "has_published_version": true,      // æ˜¯å¦æ›¾ç»å‘å¸ƒè¿‡
  
  "publish_time": "2024-01-01T12:00:00",
  "review_message": "æ›´æ–°å®¡æ ¸å¤±è´¥ï¼šå†…å®¹åŒ…å«æ•æ„Ÿè¯æ±‡",
  "folder_id": 1,
  "folder_name": "æŠ€æœ¯æ–‡æ¡£",
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T11:00:00"
}
```

**ğŸ¯ æ–°å¢å­—æ®µè¯´æ˜**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¯èƒ½å€¼ |
|------|------|------|--------|
| `publish_status` | string/null | æŠ€æœ¯å¹¿åœºå‘å¸ƒçŠ¶æ€ | `null`, `"published"`, `"unpublished"` |
| `content_status` | string | æœ€æ–°å†…å®¹å®¡æ ¸çŠ¶æ€ | `"draft"`, `"pending_review"`, `"published"`, `"review_failed"` |
| `has_published_version` | boolean | æ˜¯å¦æ›¾ç»å‘å¸ƒè¿‡ | `true`, `false` |

**ğŸ¨ å‰ç«¯çŠ¶æ€æ˜¾ç¤ºé€»è¾‘**

| æŠ€æœ¯å¹¿åœºçŠ¶æ€ | æœ€æ–°å†…å®¹çŠ¶æ€ | å‰ç«¯æ˜¾ç¤º | ç”¨æˆ·æ“ä½œ |
|-------------|-------------|----------|----------|
| `null` | `"draft"` | ğŸ“ è‰ç¨¿ | å‘å¸ƒ |
| `null` | `"review_failed"` | âŒ å®¡æ ¸å¤±è´¥ | é‡æ–°å‘å¸ƒ |
| `"published"` | `"published"` | âœ… å·²å‘å¸ƒ | æ›´æ–°å‘å¸ƒã€å–æ¶ˆå‘å¸ƒ |
| `"published"` | `"pending_review"` | ğŸ”„ æ›´æ–°å®¡æ ¸ä¸­ | ç­‰å¾…ï¼ˆæŠ€æœ¯å¹¿åœºæ˜¾ç¤ºæ—§ç‰ˆæœ¬ï¼‰ |
| `"published"` | `"review_failed"` | âš ï¸ æ›´æ–°å¤±è´¥ | é‡æ–°æ›´æ–°ï¼ˆæŠ€æœ¯å¹¿åœºæ˜¾ç¤ºæ—§ç‰ˆæœ¬ï¼‰ |

**ğŸ’¡ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
- âœ… **çŠ¶æ€æŒä¹…åŒ–**ï¼šåˆ·æ–°é¡µé¢çŠ¶æ€ä¸ä¼šå˜åŒ–
- âœ… **é€»è¾‘æ¸…æ™°**ï¼šåŒºåˆ†"æŠ€æœ¯å¹¿åœºæ˜¯å¦æœ‰å†…å®¹"å’Œ"æœ€æ–°å†…å®¹å®¡æ ¸çŠ¶æ€"
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜ç¡®çŸ¥é“åº”è¯¥ç‚¹å‡»"å‘å¸ƒ"è¿˜æ˜¯"æ›´æ–°å‘å¸ƒ"
- âœ… **æŠ€æœ¯å¹¿åœºç¨³å®š**ï¼šæ›´æ–°å¤±è´¥ä¸å½±å“å·²å‘å¸ƒå†…å®¹æ˜¾ç¤º

---

### 7. æ›´æ–°æ–‡æ¡£

**æ¥å£ä¿¡æ¯**
```
PUT /api/v2/document_manager/documents/{doc_id}
Content-Type: application/json
Authorization: Bearer <token>
```

**è¯·æ±‚å‚æ•°**
```json
{
  "title": "string",          // æ–‡æ¡£æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
  "content": "string",        // æ–‡æ¡£å†…å®¹ï¼ˆå¯é€‰ï¼‰
  "summary": "string",        // ç®€çŸ­æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
  "folder_id": 2              // æ‰€å±æ–‡ä»¶å¤¹IDï¼ˆå¯é€‰ï¼Œ0è¡¨ç¤ºç§»åˆ°æ ¹ç›®å½•ï¼‰
}
```

**æˆåŠŸå“åº” (200)**
```json
{
  "id": 1,
  "title": "FastAPIé«˜çº§å¼€å‘æŒ‡å—",
  "content": "# FastAPIé«˜çº§å¼€å‘æŒ‡å—\n\næ›´æ–°åçš„å†…å®¹...",
  "file_path": null,
  "file_type": "md",
  "file_size": 3072,
  "summary": "FastAPIæ¡†æ¶çš„é«˜çº§ä½¿ç”¨æ•™ç¨‹",
  "status": "draft",
  
  // ğŸ†• æ–°å¢çŠ¶æ€å­—æ®µ
  "publish_status": "published",
  "content_status": "draft",
  "has_published_version": true,
  
  "publish_time": null,
  "review_message": null,
  "folder_id": 2,
  "folder_name": "é«˜çº§æ•™ç¨‹",
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T11:00:00"
}
```

---

### 8. åˆ é™¤æ–‡æ¡£

**æ¥å£ä¿¡æ¯**
```
DELETE /api/v2/document_manager/documents/{doc_id}
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "success": true,
  "message": "æ–‡æ¡£åˆ é™¤æˆåŠŸ",
  "data": null
}
```

---

### 9. è·å–æ–‡æ¡£åˆ—è¡¨ ğŸ†•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/documents?folder_id=1&page=1&page_size=20
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**
- `folder_id`: æ–‡ä»¶å¤¹IDç­›é€‰ï¼ˆå¯é€‰ï¼‰
  - ä¸å¡«ï¼šè·å–æ‰€æœ‰æ–‡æ¡£
  - 0ï¼šè·å–æ ¹ç›®å½•ä¸‹çš„æ–‡æ¡£
  - å…¶ä»–æ•°å­—ï¼šè·å–æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ–‡æ¡£
- `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼Œé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆ1-100ï¼Œé»˜è®¤20ï¼‰

**æˆåŠŸå“åº” (200)**
```json
{
  "documents": [
    {
      "id": 1,
      "title": "FastAPIå¼€å‘æŒ‡å—",
      "file_type": "md",
      "file_size": 2048,
      "status": "published",
      
      // ğŸ†• æ–°å¢çŠ¶æ€å­—æ®µ
      "publish_status": "published",
      "content_status": "review_failed",
      "has_published_version": true,
      
      "folder_id": 1,
      "folder_name": "æŠ€æœ¯æ–‡æ¡£",
      "created_at": "2024-01-01T10:00:00",
      "updated_at": "2024-01-01T11:00:00"
    }
  ],
  "total": 25,
  "page": 1,
  "page_size": 20,
  "total_pages": 2
}
```

**ğŸ¯ åˆ—è¡¨é¡µçŠ¶æ€æ˜¾ç¤ºå»ºè®®**
```javascript
// å‰ç«¯å¯ä»¥æ ¹æ®çŠ¶æ€ç»„åˆæ˜¾ç¤ºä¸åŒçš„æ ‡ç­¾
function getStatusBadge(doc) {
  const hasPublished = doc.publish_status === 'published'
  const contentStatus = doc.content_status
  
  if (!hasPublished && contentStatus === 'draft') {
    return { text: 'è‰ç¨¿', color: 'gray' }
  }
  if (!hasPublished && contentStatus === 'review_failed') {
    return { text: 'å®¡æ ¸å¤±è´¥', color: 'red' }
  }
  if (hasPublished && contentStatus === 'published') {
    return { text: 'å·²å‘å¸ƒ', color: 'green' }
  }
  if (hasPublished && contentStatus === 'pending_review') {
    return { text: 'æ›´æ–°å®¡æ ¸ä¸­', color: 'blue' }
  }
  if (hasPublished && contentStatus === 'review_failed') {
    return { text: 'æ›´æ–°å¤±è´¥', color: 'orange' }
  }
}
```

---

### 10. è·å–ç»Ÿè®¡ä¿¡æ¯

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/stats
Authorization: Bearer <token>
```

**æˆåŠŸå“åº” (200)**
```json
{
  "total_documents": 15,
  "total_folders": 5,
  "documents_by_status": {
    "draft": 8,
    "published": 6,
    "review_failed": 1
  },
  "user_id": 1
}
```

---

### 11. ä¸‹è½½æ–‡æ¡£æ–‡ä»¶ ğŸ†•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/documents/{doc_id}/download?preview=false
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**
- `preview`: æ˜¯å¦ä¸ºé¢„è§ˆæ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰
  - `true`: æµè§ˆå™¨å†…é¢„è§ˆï¼ˆé€‚ç”¨äºPDFï¼‰
  - `false`: å¼ºåˆ¶ä¸‹è½½æ–‡ä»¶

**åŠŸèƒ½ç‰¹ç‚¹**
- âœ… æ”¯æŒPDFå’ŒMarkdownæ–‡ä»¶ä¸‹è½½
- âœ… è‡ªåŠ¨å¤„ç†ä¸­æ–‡æ–‡ä»¶åç¼–ç 
- âœ… æ”¯æŒé¢„è§ˆå’Œä¸‹è½½ä¸¤ç§æ¨¡å¼
- âœ… å®‰å…¨çš„æ–‡ä»¶è®¿é—®æ§åˆ¶

**æˆåŠŸå“åº” (200)**
```
Content-Type: application/pdf | text/markdown
Content-Length: 130343
Content-Disposition: attachment; filename*=UTF-8''%E6%96%87%E6%A1%A3%E6%A0%87%E9%A2%98.pdf

[æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®]
```

**é”™è¯¯å“åº”**
```json
// 404 - æ–‡æ¡£ä¸å­˜åœ¨
{
  "detail": "æ–‡æ¡£ä¸å­˜åœ¨"
}

// 404 - æ–‡ä»¶ä¸å­˜åœ¨
{
  "detail": "æ–‡æ¡£æ²¡æœ‰å…³è”çš„æ–‡ä»¶"
}

// 404 - ç‰©ç†æ–‡ä»¶ä¸å­˜åœ¨
{
  "detail": "æ–‡ä»¶ä¸å­˜åœ¨"
}
```

**ä½¿ç”¨ç¤ºä¾‹**
```javascript
// ä¸‹è½½æ–‡ä»¶
const downloadUrl = `http://localhost:8100/api/v2/document_manager/documents/${docId}/download`

// é¢„è§ˆPDFï¼ˆæµè§ˆå™¨å†…æ‰“å¼€ï¼‰
const previewUrl = `http://localhost:8100/api/v2/document_manager/documents/${docId}/download?preview=true`
```

---

### 12. æµå¼ä¼ è¾“æ–‡æ¡£ ğŸ†•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/documents/{doc_id}/stream
Authorization: Bearer <token>
```

**åŠŸèƒ½ç‰¹ç‚¹**
- âœ… ä¸“é—¨ä¼˜åŒ–PDFé¢„è§ˆä½“éªŒ
- âœ… åˆ†å—ä¼ è¾“ï¼Œæ”¯æŒå¤§æ–‡ä»¶ï¼ˆ8KB chunksï¼‰
- âœ… æµè§ˆå™¨è‡ªåŠ¨é€‰æ‹©PDFé˜…è¯»å™¨
- âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆAccept-Rangesï¼‰

**æˆåŠŸå“åº” (200)**
```
Content-Type: application/pdf
Content-Length: 130343
Content-Disposition: inline; filename*=UTF-8''%E6%96%87%E6%A1%A3%E6%A0%87%E9%A2%98.pdf
Accept-Ranges: bytes

[æ–‡ä»¶æµæ•°æ®]
```

**æ¨èç”¨æ³•**
```javascript
// æ¨èï¼šç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€PDF
const pdfUrl = `http://localhost:8100/api/v2/document_manager/documents/${docId}/stream`
window.open(pdfUrl, '_blank')

// æˆ–è€…åµŒå…¥åˆ°iframeä¸­
const iframe = document.createElement('iframe')
iframe.src = pdfUrl
iframe.width = '100%'
iframe.height = '600px'
document.body.appendChild(iframe)
```

**æµè§ˆå™¨å…¼å®¹æ€§**
- âœ… **Chrome/Edge**: å®Œç¾æ”¯æŒPDFå†…åµŒé¢„è§ˆ
- âœ… **Firefox**: æ”¯æŒPDFé¢„è§ˆå’Œä¸‹è½½
- âœ… **Safari**: æ”¯æŒPDFé¢„è§ˆ
- âœ… **ç§»åŠ¨ç«¯**: è‡ªåŠ¨è°ƒç”¨ç³»ç»ŸPDFé˜…è¯»å™¨

---

### 13. è·å–æ–‡æ¡£æ–‡ä»¶ä¿¡æ¯ ğŸ†•

**æ¥å£ä¿¡æ¯**
```
GET /api/v2/document_manager/documents/{doc_id}/info
Authorization: Bearer <token>
```

**åŠŸèƒ½ç‰¹ç‚¹**
- âœ… è·å–æ–‡ä»¶å…ƒä¿¡æ¯ï¼Œä¸ä¸‹è½½å†…å®¹
- âœ… æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
- âœ… éªŒè¯æ–‡ä»¶å¤§å°åŒ¹é…
- âœ… æä¾›MIMEç±»å‹ä¿¡æ¯

**æˆåŠŸå“åº” (200)**
```json
{
  "document_id": 84,
  "title": "2025.10.20å‘¨æŠ¥",
  "file_type": "pdf",
  "file_size": 130343,
  "has_file": true,
  "file_path": "/path/to/file.pdf",
  "safe_filename": "2025.10.20å‘¨æŠ¥.pdf",
  "file_exists": true,
  "original_filename": "2025.10.20å‘¨æŠ¥.pdf",
  "actual_file_size": 130343,
  "mime_type": "application/pdf",
  "size_match": true
}
```

**å­—æ®µè¯´æ˜**
- `document_id`: æ–‡æ¡£ID
- `title`: æ–‡æ¡£æ ‡é¢˜
- `file_type`: æ–‡ä»¶ç±»å‹ï¼ˆmd/pdfï¼‰
- `file_size`: æ•°æ®åº“è®°å½•çš„æ–‡ä»¶å¤§å°
- `has_file`: æ˜¯å¦æœ‰å…³è”æ–‡ä»¶
- `file_path`: æ–‡ä»¶å­˜å‚¨è·¯å¾„
- `safe_filename`: å®‰å…¨çš„æ–‡ä»¶åï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
- `file_exists`: ç‰©ç†æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- `actual_file_size`: å®é™…æ–‡ä»¶å¤§å°
- `mime_type`: MIMEç±»å‹
- `size_match`: æ•°æ®åº“è®°å½•ä¸å®é™…æ–‡ä»¶å¤§å°æ˜¯å¦åŒ¹é…

---

## ğŸ†• çŠ¶æ€å­—æ®µè¿ç§»æŒ‡å—

### å‘åå…¼å®¹æ€§
- âœ… **åŸæœ‰ `status` å­—æ®µä¿æŒä¸å˜**ï¼Œç¡®ä¿ç°æœ‰åŠŸèƒ½æ­£å¸¸
- âœ… **æ–°å¢å­—æ®µä¸ºé¢å¤–å­—æ®µ**ï¼Œä¸å½±å“ç°æœ‰é€»è¾‘
- âœ… **æ¸è¿›å¼è¿ç§»**ï¼Œå¯ä»¥å¹¶è¡Œå¼€å‘

### å‰ç«¯é›†æˆå»ºè®®

**ç¬¬ä¸€é˜¶æ®µï¼šå…¼å®¹æ€§éªŒè¯**
```javascript
// æ£€æŸ¥æ–°å­—æ®µæ˜¯å¦å­˜åœ¨
function hasNewStatusFields(doc) {
  return doc.hasOwnProperty('publish_status') && 
         doc.hasOwnProperty('content_status') && 
         doc.hasOwnProperty('has_published_version')
}

// å…¼å®¹æ€§å¤„ç†
function getDocumentStatus(doc) {
  if (hasNewStatusFields(doc)) {
    // ä½¿ç”¨æ–°çš„çŠ¶æ€é€»è¾‘
    return getNewStatusDisplay(doc)
  } else {
    // ä½¿ç”¨åŸæœ‰çŠ¶æ€é€»è¾‘
    return getOldStatusDisplay(doc)
  }
}
```

**ç¬¬äºŒé˜¶æ®µï¼šæ–°çŠ¶æ€é€»è¾‘**
```javascript
function getNewStatusDisplay(doc) {
  const hasPublished = doc.publish_status === 'published'
  const contentStatus = doc.content_status
  
  // æ ¹æ®çŠ¶æ€ç»„åˆè¿”å›æ˜¾ç¤ºä¿¡æ¯
  if (!hasPublished && contentStatus === 'draft') {
    return { text: 'ğŸ“ è‰ç¨¿', actions: ['publish'] }
  }
  if (!hasPublished && contentStatus === 'review_failed') {
    return { text: 'âŒ å®¡æ ¸å¤±è´¥', actions: ['republish'] }
  }
  if (hasPublished && contentStatus === 'published') {
    return { text: 'âœ… å·²å‘å¸ƒ', actions: ['update', 'unpublish'] }
  }
  if (hasPublished && contentStatus === 'pending_review') {
    return { text: 'ğŸ”„ æ›´æ–°å®¡æ ¸ä¸­', actions: [] }
  }
  if (hasPublished && contentStatus === 'review_failed') {
    return { text: 'âš ï¸ æ›´æ–°å¤±è´¥', actions: ['retry_update'] }
  }
}
```

---

## ğŸš¨ é”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ | å¸¸è§åŸå›  |
|--------|------|----------|
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | åŒåæ–‡ä»¶å¤¹/æ–‡æ¡£ã€å±‚çº§è¶…é™ã€æ–‡ä»¶å¤¹ä¸ä¸ºç©º |
| 401 | è®¤è¯å¤±è´¥ | Tokenæ— æ•ˆã€ç”¨æˆ·ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨ |
| 404 | èµ„æºä¸å­˜åœ¨ | æ–‡ä»¶å¤¹/æ–‡æ¡£ä¸å­˜åœ¨ã€æ–‡ä»¶ä¸å­˜åœ¨ã€æ— æƒé™è®¿é—® |
| 422 | æ•°æ®éªŒè¯å¤±è´¥ | å‚æ•°æ ¼å¼é”™è¯¯ã€å¿…å¡«å­—æ®µç¼ºå¤± |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ•°æ®åº“è¿æ¥å¤±è´¥ã€æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ã€ç³»ç»Ÿå¼‚å¸¸ |

---

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### æ–‡ä»¶å¤¹ç®¡ç†
- **å±‚çº§é™åˆ¶**ï¼šæœ€å¤šæ”¯æŒ3å±‚æ–‡ä»¶å¤¹ç»“æ„
- **å‘½åè§„åˆ™**ï¼šä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ `/ \ : * ? " < > |`
- **åˆ é™¤é™åˆ¶**ï¼šåªèƒ½åˆ é™¤ç©ºæ–‡ä»¶å¤¹

### æ–‡æ¡£ç®¡ç†
- **æ–‡ä»¶ç±»å‹**ï¼šæ”¯æŒ `md`ï¼ˆMarkdownï¼‰å’Œ `pdf`
- **çŠ¶æ€æµè½¬**ï¼š`draft` â†’ `published` / `review_failed`
- **åŒåæ£€æŸ¥**ï¼šåŒä¸€æ–‡ä»¶å¤¹ä¸‹ä¸èƒ½æœ‰åŒåæ–‡æ¡£

### ğŸ†• çŠ¶æ€ç®¡ç†ï¼ˆé‡è¦æ›´æ–°ï¼‰
- **åŒçŠ¶æ€è®¾è®¡**ï¼šåŒºåˆ†"æŠ€æœ¯å¹¿åœºå‘å¸ƒçŠ¶æ€"å’Œ"æœ€æ–°å†…å®¹å®¡æ ¸çŠ¶æ€"
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šåˆ·æ–°é¡µé¢çŠ¶æ€ä¸ä¼šæ”¹å˜
- **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šæ˜ç¡®çš„æ“ä½œæŒ‡å¼•å’ŒçŠ¶æ€æ˜¾ç¤º
- **æŠ€æœ¯å¹¿åœºç¨³å®šæ€§**ï¼šæ›´æ–°å¤±è´¥ä¸å½±å“å·²å‘å¸ƒå†…å®¹

### æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ ğŸ†•
- **ä¸‰ç§è®¿é—®æ–¹å¼**ï¼š
  - `/download`: é€šç”¨ä¸‹è½½ï¼Œæ”¯æŒé¢„è§ˆ/ä¸‹è½½æ¨¡å¼åˆ‡æ¢
  - `/stream`: PDFé¢„è§ˆä¼˜åŒ–ï¼Œæ¨èç”¨äºPDFæ–‡ä»¶
  - `/info`: è·å–æ–‡ä»¶å…ƒæ•°æ®ï¼Œä¸ä¸‹è½½å†…å®¹
- **ä¸­æ–‡æ–‡ä»¶åæ”¯æŒ**ï¼šä½¿ç”¨RFC 5987æ ‡å‡†ç¼–ç 
- **å®‰å…¨æ§åˆ¶**ï¼šåªèƒ½è®¿é—®è‡ªå·±çš„æ–‡æ¡£æ–‡ä»¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†å—ä¼ è¾“ï¼Œæ”¯æŒå¤§æ–‡ä»¶å’Œæ–­ç‚¹ç»­ä¼ 

### åˆ†é¡µæŸ¥è¯¢
- **é»˜è®¤æ’åº**ï¼šæŒ‰æ›´æ–°æ—¶é—´å€’åº
- **é¡µç èŒƒå›´**ï¼šä»1å¼€å§‹
- **æ¯é¡µé™åˆ¶**ï¼š1-100æ¡è®°å½•

### å‰ç«¯é›†æˆå»ºè®®
```javascript
// 1. PDFé¢„è§ˆï¼ˆæ¨èï¼‰
function previewPDF(documentId) {
    const url = `http://localhost:8100/api/v2/document_manager/documents/${documentId}/stream`
    window.open(url, '_blank')
}

// 2. æ–‡ä»¶ä¸‹è½½
async function downloadFile(documentId) {
    const response = await fetch(`http://localhost:8100/api/v2/document_manager/documents/${documentId}/download`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    const blob = await response.blob()
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = 'document.pdf'
    a.click()
}

// 3. è·å–æ–‡ä»¶ä¿¡æ¯
async function getFileInfo(documentId) {
    const response = await fetch(`http://localhost:8100/api/v2/document_manager/documents/${documentId}/info`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    return await response.json()
}

// ğŸ†• 4. çŠ¶æ€åˆ¤æ–­å’Œæ˜¾ç¤º
function getDocumentStatusDisplay(doc) {
    const hasPublished = doc.publish_status === 'published'
    const contentStatus = doc.content_status
    
    // è¿”å›çŠ¶æ€æ˜¾ç¤ºä¿¡æ¯å’Œå¯ç”¨æ“ä½œ
    return getStatusCombination(hasPublished, contentStatus)
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.2 | **æ›´æ–°æ—¶é—´**ï¼š2024-12-19 | **æ¥å£æ€»æ•°**ï¼š11ä¸ª ğŸ“ | **ğŸ†• æ–°å¢çŠ¶æ€å­—æ®µæ”¯æŒ**